#!/usr/bin/env bash

source /usr/local/vesta/func/plugins.sh

repo_url="$1"
reinstall="${2:-no}"

plugin_name="$(basename -- "$repo_url")"
plugin_path="/usr/local/vesta/plugins/$plugin_name"

if [[ -d "$repo_url" ]]; then
    repo_type="path"
else
    repo_type="github"
    repo_url="$(echo "$repo_url" | sed -E "s|.git$||")"

    if [[ ! "$(echo "$repo_url" | grep -E "^https://github.com/[^/]*/[^/]*$")" ]]; then
        echo "Invalida github URL"
        exit
    elif [[ ! "$(curl -L -I -s "$repo_url" | grep -E "HTTP/(.*)200")" ]]; then
        echo "Github repository not found"
        exit
    fi

    # Archive link
    zip_link="$repo_url/archive/master.zip"
fi

mkdir -p /usr/local/vesta/plugins
mkdir -p /usr/local/vesta/web/plugins

if [[ -d "$plugin_path" ]]; then
    if [[ "${reinstall,,}" == "yes" || "${reinstall,,}" == "y" ]]; then
        /usr/local/vesta/bin/v-delete-plugin "$plugin_name"
    else
        echo "There is already a plugin with that name"
        exit 1
    fi
fi

if [[ "$repo_type" == "path" ]]; then
    ln -sf "$repo_url" /usr/local/vesta/plugins/
else
    # Check repository
    if [[ ! "$(curl -L -I -s "$zip_link" | grep -E "HTTP/(.*)200")" \
        || ! "$(curl -L -I -s "$zip_link" | grep -E "Content-Type: application/zip")" ]]; then
        echo "Not found" >&2
        exit
    fi

    # Download and installation
    curl -L -J "$zip_link" -o "/tmp/$plugin_name.zip"
    rm -rf "/tmp/$plugin_name-master"
    unzip "/tmp/$plugin_name.zip" -d "/tmp"
    mv "/tmp/$plugin_name-master" "/usr/local/vesta/plugins/$plugin_name"
    rm -rf "/tmp/$plugin_name.zip"
fi

# Check installation
if [[ "$(ls -A "/usr/local/vesta/plugins/$plugin_name")" ]]; then
    update_plugin_conf "$plugin_name" "$repo_url"

    # Execute configuration for plugin in the vesta environment
    /usr/local/vesta/bin/v-rebuild-plugin "$plugin_name"

    # Check if plugin has additional configurations
    if [[ -f "$plugin_path/install.sh" ]]; then
        bash "$plugin_path/install.sh"
    fi

    echo -e "\nInstallation completed"
else
    rm -rf "/usr/local/vesta/plugins/$plugin_name"
fi
