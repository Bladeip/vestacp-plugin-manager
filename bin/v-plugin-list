#!/usr/bin/env bash

type="$1"

plugins_path="/usr/local/vesta/web/plugins"

if [[ "$type" == "json" ]]; then
    list="[]"
fi

if [[ -d "$plugins_path" ]]; then
    for plugin_path in "$plugins_path/"*; do
        plugin_name="$(basename -- "$plugin_path")"

        if [[ -d "$plugin_path" && "$plugin_name" != "bin" && "$plugin_name" != "func" && "$plugin_name" != "src" ]]; then
            if [[ "$type" == "json" ]]; then
                if [[ -f "$plugin_path/plugin.json" ]]; then
                    plugin_data="$(cat "$plugin_path/plugin.json")"
                else
                    plugin_data="{}"
                fi

                plugin_data="$(echo "$plugin_data" | jq -r ".dir_name = \"$plugin_name\" | .path = \"$plugin_path\"")"
                list="$(echo "$list" | jq -s ".[] + [$plugin_data]")"
            else
                echo "$plugin_name"
            fi
        fi
    done
fi

if [[ "$type" == "json" ]]; then
    echo "$list"
fi
